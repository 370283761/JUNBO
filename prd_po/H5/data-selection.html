<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®ç»´åº¦é€‰æ‹© - ä¼˜åŒ–å¸ˆæ‰¹é‡åˆ›ç¼–</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .selection-container {
      display: flex;
      gap: var(--space-6);
      min-height: calc(100vh - 64px - 100px);
    }

    .selection-left {
      flex: 1;
      max-width: 800px;
    }

    .selection-right {
      width: 320px;
      position: sticky;
      top: var(--space-6);
      height: fit-content;
    }

    .dimension-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-4);
    }

    .dimension-title {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
      font-size: 16px;
      font-weight: 600;
    }

    .dimension-content {
      border: 1px solid var(--gray-3);
      border-radius: var(--radius-md);
      max-height: 300px;
      overflow-y: auto;
    }

    .dimension-item {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--gray-3);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      cursor: pointer;
      transition: background var(--transition-base);
    }

    .dimension-item:last-child {
      border-bottom: none;
    }

    .dimension-item:hover {
      background: var(--gray-1);
    }

    .dimension-item-info {
      flex: 1;
    }

    .dimension-item-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .dimension-item-meta {
      font-size: 12px;
      color: var(--secondary);
    }

    .dimension-count {
      margin-top: var(--space-2);
      color: var(--primary-6);
      font-size: 14px;
    }

    .filter-section {
      background: var(--gray-1);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-input-small {
      width: 80px;
    }

    .preview-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
    }

    .preview-section {
      margin-bottom: var(--space-5);
    }

    .preview-section:last-child {
      margin-bottom: 0;
    }

    .preview-section-title {
      font-size: 14px;
      color: var(--secondary);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) 0;
      border-bottom: 1px dashed var(--gray-3);
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--text);
    }

    .stat-value {
      font-weight: 600;
      color: var(--primary-6);
    }

    .estimate-box {
      background: var(--primary-1);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      text-align: center;
      margin-top: var(--space-3);
    }

    .estimate-label {
      font-size: 12px;
      color: var(--secondary);
      margin-bottom: var(--space-2);
    }

    .estimate-value {
      font-size: 32px;
      font-weight: 600;
      color: var(--primary-6);
    }

    .estimate-hint {
      font-size: 12px;
      color: var(--secondary);
      margin-top: var(--space-2);
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <h1 class="page-title">ä¼˜åŒ–å¸ˆæ‰¹é‡åˆ›ç¼– > é€‰æ‹©æ•°æ®ç»´åº¦</h1>
      <div class="flex gap-3">
        <button class="btn btn-default" onclick="goBack()">â† è¿”å›</button>
      </div>
    </div>

    <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
    <div class="steps">
      <div class="step current">
        <div class="step-icon">1</div>
        <div class="step-label">é€‰æ‹©ç»´åº¦</div>
      </div>
      <div class="step-line"></div>
      <div class="step">
        <div class="step-icon">2</div>
        <div class="step-label">é…ç½®è§„åˆ™</div>
      </div>
      <div class="step-line"></div>
      <div class="step">
        <div class="step-icon">3</div>
        <div class="step-label">é¢„è§ˆç»“æœ</div>
      </div>
      <div class="step-line"></div>
      <div class="step">
        <div class="step-icon">4</div>
        <div class="step-label">æäº¤åˆ›å»º</div>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="page-content">
      <div class="selection-container">
        <!-- å·¦ä¾§ï¼šç»´åº¦é€‰æ‹© -->
        <div class="selection-left">
          <!-- 1. é€‰æ‹©ä¸»ä½“ -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>1ï¸âƒ£</span>
              <span>é€‰æ‹©ä¸»ä½“</span>
              <span style="color: var(--error);">*</span>
            </div>
            <input type="text" class="input" placeholder="æœç´¢ä¸»ä½“..." id="searchSubject" style="margin-bottom: 12px;">
            <div class="dimension-content" id="subjectList">
              <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="dimension-count" id="subjectCount">å·²é€‰æ‹© 0 ä¸ªä¸»ä½“</div>
          </div>

          <!-- 2. ç­›é€‰è´¦æˆ· -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>2ï¸âƒ£</span>
              <span>ç­›é€‰è´¦æˆ·</span>
              <span style="font-size: 12px; color: var(--secondary); font-weight: normal;">ï¼ˆå¯é€‰ï¼‰</span>
            </div>
            <div class="filter-section">
              <div class="filter-row">
                <label class="checkbox">
                  <input type="checkbox" id="filterConversion" onchange="updateFilters()">
                  <span>è½¬åŒ–æ•° ></span>
                </label>
                <input type="number" class="input filter-input-small" id="conversionMin" value="6" min="0">
              </div>
              <div class="filter-row">
                <label class="checkbox">
                  <input type="checkbox" id="filterOpenDays" onchange="updateFilters()">
                  <span>å¼€æˆ·å¤©æ•° <</span>
                </label>
                <input type="number" class="input filter-input-small" id="openDaysMax" value="5" min="0">
              </div>
              <div class="filter-row">
                <label class="checkbox">
                  <input type="checkbox" id="filterStatus" onchange="updateFilters()">
                  <span>è´¦æˆ·çŠ¶æ€ï¼š</span>
                </label>
                <select class="input" id="accountStatus" style="width: 120px;">
                  <option value="running">è·‘é‡</option>
                  <option value="testing">æµ‹è¯•</option>
                  <option value="paused">æš‚åœ</option>
                </select>
              </div>
            </div>
            <div class="dimension-count" id="accountCount">ç¬¦åˆæ¡ä»¶ï¼š0 ä¸ªè´¦æˆ·</div>
          </div>

          <!-- 3. é€‰æ‹©é¡¹ç›® -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>3ï¸âƒ£</span>
              <span>é€‰æ‹©é¡¹ç›®</span>
              <span style="color: var(--error);">*</span>
            </div>
            <div class="dimension-content" id="projectList">
              <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="dimension-count" id="projectCount">å·²é€‰æ‹© 0 ä¸ªé¡¹ç›®</div>
          </div>

          <!-- 4. é€‰æ‹©å°è¯´ -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>4ï¸âƒ£</span>
              <span>é€‰æ‹©å°è¯´</span>
            </div>
            <input type="text" class="input" placeholder="æœç´¢å°è¯´..." id="searchBook" style="margin-bottom: 12px;">
            <div class="dimension-content" id="bookList">
              <!-- åŠ¨æ€å¡«å…… -->
            </div>
            <div class="dimension-count" id="bookCount">å·²é€‰æ‹© 0 ä¸ªå°è¯´</div>
          </div>

          <!-- 5. é€‰æ‹©ç´ æ -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>5ï¸âƒ£</span>
              <span>é€‰æ‹©ç´ æ</span>
              <span style="color: var(--error);">*</span>
            </div>
            <div style="margin-bottom: 12px;">
              <label style="font-weight: 500; display: block; margin-bottom: 8px;">ç´ æç±»å‹ï¼š</label>
              <label class="checkbox" style="margin-right: 16px;">
                <input type="checkbox" value="decompress" onchange="updateMaterials()" checked>
                <span>è§£å‹ (<span id="decompressCount">0</span>ä¸ª)</span>
              </label>
              <label class="checkbox" style="margin-right: 16px;">
                <input type="checkbox" value="scroll" onchange="updateMaterials()" checked>
                <span>æ»šå± (<span id="scrollCount">0</span>ä¸ª)</span>
              </label>
              <label class="checkbox">
                <input type="checkbox" value="adx" onchange="updateMaterials()" checked>
                <span>ADX (<span id="adxCount">0</span>ä¸ª)</span>
              </label>
            </div>
            <div class="dimension-count" id="materialCount">å·²é€‰æ‹© 0 ä¸ªç´ æ</div>
          </div>
        </div>

        <!-- å³ä¾§ï¼šå®æ—¶é¢„è§ˆ -->
        <div class="selection-right">
          <div class="preview-card">
            <div class="preview-section">
              <div class="preview-section-title">
                <span>ğŸ“Š</span>
                <span>æ•°æ®ç»Ÿè®¡</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ä¸»ä½“æ•°é‡ï¼š</span>
                <span class="stat-value" id="previewSubjects">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">è´¦æˆ·æ•°é‡ï¼š</span>
                <span class="stat-value" id="previewAccounts">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">é¡¹ç›®æ•°é‡ï¼š</span>
                <span class="stat-value" id="previewProjects">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">å°è¯´æ•°é‡ï¼š</span>
                <span class="stat-value" id="previewBooks">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ç´ ææ•°é‡ï¼š</span>
                <span class="stat-value" id="previewMaterials">0</span>
              </div>
            </div>

            <div class="preview-section">
              <div class="preview-section-title">
                <span>ğŸ’¡</span>
                <span>ç”Ÿæˆé¢„ä¼°</span>
              </div>
              <div class="estimate-box">
                <div class="estimate-label">æ ¹æ®å½“å‰é€‰æ‹©ï¼Œé¢„è®¡ç”Ÿæˆï¼š</div>
                <div class="estimate-value" id="estimatedCount">0</div>
                <div class="estimate-hint">æ¡å¹¿å‘Šè®¡åˆ’</div>
              </div>
              <div class="alert alert-info" style="margin-top: 12px; font-size: 12px;">
                <span>âš ï¸</span>
                <span>è¯·åœ¨ä¸‹ä¸€æ­¥é…ç½®ç”Ÿæˆè§„åˆ™</span>
              </div>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 20px;" onclick="nextStep()" id="nextBtn" disabled>
              ä¸‹ä¸€æ­¥ â†’
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/main.js"></script>
  <script src="js/generation-engine.js"></script>
  <script>
    // æ¨¡æ‹Ÿæ•°æ®
    const mockData = {
      subjects: [
        { id: 'SUB001', name: 'ä¸»ä½“A', type: 'running', accountCount: 5, conversionCount: 120 },
        { id: 'SUB002', name: 'ä¸»ä½“B', type: 'running', accountCount: 3, conversionCount: 85 },
        { id: 'SUB003', name: 'ä¸»ä½“C', type: 'testing', accountCount: 2, conversionCount: 45 },
        { id: 'SUB004', name: 'ä¸»ä½“D', type: 'paused', accountCount: 2, conversionCount: 10 }
      ],
      accounts: [
        { id: 'ACC001', subjectId: 'SUB001', name: 'è´¦æˆ·1', conversionCount: 25, openDays: 3, status: 'running' },
        { id: 'ACC002', subjectId: 'SUB001', name: 'è´¦æˆ·2', conversionCount: 18, openDays: 4, status: 'running' },
        { id: 'ACC003', subjectId: 'SUB001', name: 'è´¦æˆ·3', conversionCount: 30, openDays: 10, status: 'running' },
        { id: 'ACC004', subjectId: 'SUB002', name: 'è´¦æˆ·4', conversionCount: 8, openDays: 2, status: 'running' },
        { id: 'ACC005', subjectId: 'SUB002', name: 'è´¦æˆ·5', conversionCount: 12, openDays: 6, status: 'running' },
        { id: 'ACC006', subjectId: 'SUB003', name: 'è´¦æˆ·6', conversionCount: 5, openDays: 1, status: 'testing' }
      ],
      projects: [
        { id: 'PRJ001', name: 'é¡¹ç›®1 - éœ¸é“æ€»è£', category: 'è¨€æƒ…' },
        { id: 'PRJ002', name: 'é¡¹ç›®2 - ç©¿è¶Šé‡ç”Ÿ', category: 'ç©¿è¶Š' },
        { id: 'PRJ003', name: 'é¡¹ç›®3 - éƒ½å¸‚è¨€æƒ…', category: 'è¨€æƒ…' }
      ],
      books: [
        { id: 'BOOK001', projectId: 'PRJ001', name: 'ã€Šæ€»è£çš„æ›¿èº«å¦»å­ã€‹' },
        { id: 'BOOK002', projectId: 'PRJ001', name: 'ã€Šè±ªé—¨å¥‘çº¦ã€‹' },
        { id: 'BOOK003', projectId: 'PRJ002', name: 'ã€Šé‡ç”Ÿä¹‹è±ªé—¨åƒé‡‘ã€‹' },
        { id: 'BOOK004', projectId: 'PRJ003', name: 'ã€Šéƒ½å¸‚æƒ…ç¼˜ã€‹' }
      ],
      materials: [
        { id: 'MAT001', type: 'decompress', source: 'adx', exposure: 10000, clicks: 500 },
        { id: 'MAT002', type: 'decompress', source: 'self-edit', exposure: 8000, clicks: 400 },
        { id: 'MAT003', type: 'decompress', source: 'self-edit', exposure: 6000, clicks: 300 },
        { id: 'MAT004', type: 'scroll', source: 'adx', exposure: 12000, clicks: 800 },
        { id: 'MAT005', type: 'scroll', source: 'self-edit', exposure: 9000, clicks: 600 },
        { id: 'MAT006', type: 'adx', source: 'adx', exposure: 15000, clicks: 1000 }
      ]
    };

    let selectedData = {
      subjects: [],
      accounts: [],
      projects: [],
      books: [],
      materials: []
    };

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      renderSubjects();
      renderProjects();
      renderBooks();
      updateMaterialCounts();
      updateMaterials();
      updatePreview();
    });

    // æ¸²æŸ“ä¸»ä½“åˆ—è¡¨
    function renderSubjects() {
      const container = document.getElementById('subjectList');
      const searchText = document.getElementById('searchSubject').value.toLowerCase();

      const filtered = mockData.subjects.filter(s =>
        s.name.toLowerCase().includes(searchText)
      );

      container.innerHTML = filtered.map(subject => `
        <div class="dimension-item" onclick="toggleSubject('${subject.id}')">
          <input type="checkbox" ${selectedData.subjects.some(s => s.id === subject.id) ? 'checked' : ''}
                 onchange="event.stopPropagation()">
          <div class="dimension-item-info">
            <div class="dimension-item-name">${subject.name} (${subject.type === 'running' ? 'è·‘é‡' : subject.type === 'testing' ? 'æµ‹è¯•' : 'æš‚åœ'})</div>
            <div class="dimension-item-meta">è´¦æˆ·:${subject.accountCount} è½¬åŒ–:${subject.conversionCount}</div>
          </div>
        </div>
      `).join('');
    }

    // æ¸²æŸ“é¡¹ç›®åˆ—è¡¨
    function renderProjects() {
      const container = document.getElementById('projectList');
      container.innerHTML = mockData.projects.map(project => `
        <div class="dimension-item" onclick="toggleProject('${project.id}')">
          <input type="checkbox" ${selectedData.projects.some(p => p.id === project.id) ? 'checked' : ''}
                 onchange="event.stopPropagation()">
          <div class="dimension-item-info">
            <div class="dimension-item-name">${project.name}</div>
            <div class="dimension-item-meta">${project.category}</div>
          </div>
        </div>
      `).join('');
    }

    // æ¸²æŸ“å°è¯´åˆ—è¡¨
    function renderBooks() {
      const container = document.getElementById('bookList');
      const searchText = document.getElementById('searchBook').value.toLowerCase();

      const filtered = mockData.books.filter(b =>
        b.name.toLowerCase().includes(searchText)
      );

      container.innerHTML = filtered.map(book => `
        <div class="dimension-item" onclick="toggleBook('${book.id}')">
          <input type="checkbox" ${selectedData.books.some(b => b.id === book.id) ? 'checked' : ''}
                 onchange="event.stopPropagation()">
          <div class="dimension-item-info">
            <div class="dimension-item-name">${book.name}</div>
          </div>
        </div>
      `).join('');
    }

    // åˆ‡æ¢ä¸»ä½“é€‰æ‹©
    function toggleSubject(id) {
      const subject = mockData.subjects.find(s => s.id === id);
      const index = selectedData.subjects.findIndex(s => s.id === id);

      if (index > -1) {
        selectedData.subjects.splice(index, 1);
        // ç§»é™¤è¯¥ä¸»ä½“ä¸‹çš„è´¦æˆ·
        selectedData.accounts = selectedData.accounts.filter(a => a.subjectId !== id);
      } else {
        selectedData.subjects.push(subject);
        // è‡ªåŠ¨æ·»åŠ è¯¥ä¸»ä½“ä¸‹çš„è´¦æˆ·
        const subjectAccounts = mockData.accounts.filter(a => a.subjectId === id);
        selectedData.accounts.push(...subjectAccounts);
      }

      renderSubjects();
      updateFilters();
      updatePreview();
    }

    // åˆ‡æ¢é¡¹ç›®é€‰æ‹©
    function toggleProject(id) {
      const project = mockData.projects.find(p => p.id === id);
      const index = selectedData.projects.findIndex(p => p.id === id);

      if (index > -1) {
        selectedData.projects.splice(index, 1);
      } else {
        selectedData.projects.push(project);
      }

      renderProjects();
      updatePreview();
    }

    // åˆ‡æ¢å°è¯´é€‰æ‹©
    function toggleBook(id) {
      const book = mockData.books.find(b => b.id === id);
      const index = selectedData.books.findIndex(b => b.id === id);

      if (index > -1) {
        selectedData.books.splice(index, 1);
      } else {
        selectedData.books.push(book);
      }

      renderBooks();
      updatePreview();
    }

    // æ›´æ–°ç´ ææ•°é‡
    function updateMaterialCounts() {
      document.getElementById('decompressCount').textContent =
        mockData.materials.filter(m => m.type === 'decompress').length;
      document.getElementById('scrollCount').textContent =
        mockData.materials.filter(m => m.type === 'scroll').length;
      document.getElementById('adxCount').textContent =
        mockData.materials.filter(m => m.type === 'adx').length;
    }

    // æ›´æ–°ç´ æé€‰æ‹©
    function updateMaterials() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"][value]');
      const selectedTypes = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      selectedData.materials = mockData.materials.filter(m =>
        selectedTypes.includes(m.type)
      );

      updatePreview();
    }

    // æ›´æ–°è´¦æˆ·ç­›é€‰
    function updateFilters() {
      const useConversion = document.getElementById('filterConversion').checked;
      const useOpenDays = document.getElementById('filterOpenDays').checked;
      const useStatus = document.getElementById('filterStatus').checked;

      const conversionMin = parseInt(document.getElementById('conversionMin').value) || 0;
      const openDaysMax = parseInt(document.getElementById('openDaysMax').value) || 999;
      const accountStatus = document.getElementById('accountStatus').value;

      // è·å–æ‰€æœ‰é€‰ä¸­ä¸»ä½“çš„è´¦æˆ·
      let accounts = [];
      selectedData.subjects.forEach(subject => {
        accounts.push(...mockData.accounts.filter(a => a.subjectId === subject.id));
      });

      // åº”ç”¨ç­›é€‰
      if (useConversion) {
        accounts = accounts.filter(a => a.conversionCount > conversionMin);
      }
      if (useOpenDays) {
        accounts = accounts.filter(a => a.openDays < openDaysMax);
      }
      if (useStatus) {
        accounts = accounts.filter(a => a.status === accountStatus);
      }

      selectedData.accounts = accounts;
      updatePreview();
    }

    // æ›´æ–°é¢„è§ˆ
    function updatePreview() {
      // æ›´æ–°è®¡æ•°
      document.getElementById('subjectCount').textContent = `å·²é€‰æ‹© ${selectedData.subjects.length} ä¸ªä¸»ä½“`;
      document.getElementById('accountCount').textContent = `ç¬¦åˆæ¡ä»¶ï¼š${selectedData.accounts.length} ä¸ªè´¦æˆ·`;
      document.getElementById('projectCount').textContent = `å·²é€‰æ‹© ${selectedData.projects.length} ä¸ªé¡¹ç›®`;
      document.getElementById('bookCount').textContent = `å·²é€‰æ‹© ${selectedData.books.length} ä¸ªå°è¯´`;
      document.getElementById('materialCount').textContent = `å·²é€‰æ‹© ${selectedData.materials.length} ä¸ªç´ æ`;

      // æ›´æ–°å³ä¾§ç»Ÿè®¡
      document.getElementById('previewSubjects').textContent = selectedData.subjects.length;
      document.getElementById('previewAccounts').textContent = selectedData.accounts.length;
      document.getElementById('previewProjects').textContent = selectedData.projects.length;
      document.getElementById('previewBooks').textContent = selectedData.books.length;
      document.getElementById('previewMaterials').textContent = selectedData.materials.length;

      // æ›´æ–°é¢„ä¼°ï¼ˆæš‚æ—¶æ˜¾ç¤º0ï¼Œéœ€è¦é…ç½®è§„åˆ™åæ‰èƒ½è®¡ç®—ï¼‰
      document.getElementById('estimatedCount').textContent = '?';

      // éªŒè¯å¿…å¡«é¡¹
      const valid = selectedData.subjects.length > 0 &&
                    selectedData.projects.length > 0 &&
                    selectedData.materials.length > 0;
      document.getElementById('nextBtn').disabled = !valid;
    }

    // æœç´¢
    document.getElementById('searchSubject').addEventListener('input', debounce(renderSubjects, 300));
    document.getElementById('searchBook').addEventListener('input', debounce(renderBooks, 300));

    // ä¸‹ä¸€æ­¥
    function nextStep() {
      // ä¿å­˜é€‰æ‹©çš„æ•°æ®
      DataStore.save('selectedDimensions', selectedData);
      Message.success('æ•°æ®ç»´åº¦å·²é€‰æ‹©');
      setTimeout(() => {
        window.location.href = 'rule-config.html';
      }, 500);
    }

    // è¿”å›
    function goBack() {
      if (confirm('è¿”å›å°†ä¸¢å¤±å½“å‰é€‰æ‹©ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
        window.location.href = 'create-new.html';
      }
    }
  </script>
</body>
</html>
