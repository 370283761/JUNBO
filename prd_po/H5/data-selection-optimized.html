<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®ç»´åº¦é€‰æ‹© - ä¼˜åŒ–å¸ˆæ‰¹é‡åˆ›ç¼–ï¼ˆå¤§æ•°æ®ä¼˜åŒ–ç‰ˆï¼‰</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .selection-container {
      display: flex;
      gap: var(--space-6);
      min-height: calc(100vh - 64px - 100px);
    }

    .selection-left {
      flex: 1;
      max-width: 800px;
    }

    .selection-right {
      width: 320px;
      position: sticky;
      top: var(--space-6);
      height: fit-content;
    }

    .dimension-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      margin-bottom: var(--space-4);
    }

    .dimension-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      font-size: 16px;
      font-weight: 600;
    }

    .dimension-count-badge {
      font-size: 14px;
      color: var(--primary-6);
      font-weight: 500;
    }

    /* å·²é€‰é¡¹åŒºåŸŸ */
    .selected-area {
      background: var(--primary-1);
      border: 1px solid var(--primary-3);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      min-height: 46px;
    }

    .selected-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .selected-label {
      font-size: 12px;
      color: var(--secondary);
    }

    .selected-clear {
      font-size: 12px;
      color: var(--primary-6);
      cursor: pointer;
    }

    .selected-clear:hover {
      text-decoration: underline;
    }

    .selection-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .selection-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: var(--white);
      border: 1px solid var(--primary-4);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--text);
    }

    .selection-tag-close {
      cursor: pointer;
      color: var(--error);
      font-weight: bold;
    }

    .selection-tag-close:hover {
      color: var(--error-7);
    }

    .selection-tag-more {
      background: var(--gray-2);
      border-color: var(--gray-4);
      color: var(--secondary);
    }

    /* æœç´¢æ¡† */
    .search-box {
      position: relative;
      margin-bottom: var(--space-3);
    }

    .search-input {
      width: 100%;
      padding: var(--space-2) var(--space-10) var(--space-2) var(--space-3);
      border: 1px solid var(--gray-4);
      border-radius: var(--radius-md);
      font-size: 14px;
    }

    .search-input:focus {
      border-color: var(--primary-6);
      outline: none;
      box-shadow: 0 0 0 2px var(--primary-2);
    }

    .search-icon {
      position: absolute;
      right: var(--space-3);
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
      pointer-events: none;
    }

    .search-clear {
      position: absolute;
      right: var(--space-8);
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary);
      cursor: pointer;
      font-size: 16px;
      display: none;
    }

    .search-clear.active {
      display: block;
    }

    .search-clear:hover {
      color: var(--error);
    }

    /* åˆ—è¡¨å®¹å™¨ */
    .list-container {
      border: 1px solid var(--gray-3);
      border-radius: var(--radius-md);
      height: 300px;
      overflow-y: auto;
      position: relative;
    }

    .list-item {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--gray-2);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      cursor: pointer;
      transition: background var(--transition-base);
      box-sizing: border-box;
    }

    .list-item:hover {
      background: var(--gray-1);
    }

    .list-item.selected {
      background: var(--primary-1);
    }

    .list-item-checkbox {
      flex-shrink: 0;
    }

    .list-item-info {
      flex: 1;
      min-width: 0;
    }

    .list-item-name {
      font-weight: 500;
      margin-bottom: 2px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .list-item-meta {
      font-size: 12px;
      color: var(--secondary);
    }

    .list-loading {
      text-align: center;
      padding: var(--space-4);
      color: var(--secondary);
    }

    .list-empty {
      text-align: center;
      padding: var(--space-8);
      color: var(--secondary);
    }

    .list-footer {
      margin-top: var(--space-2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: var(--secondary);
    }

    .load-more-btn {
      color: var(--primary-6);
      cursor: pointer;
    }

    .load-more-btn:hover {
      text-decoration: underline;
    }

    .load-more-btn.loading {
      color: var(--secondary);
      cursor: not-allowed;
    }

    /* ç­›é€‰åŒºåŸŸ */
    .filter-section {
      background: var(--gray-1);
      padding: var(--space-4);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }

    .filter-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .filter-row:last-child {
      margin-bottom: 0;
    }

    .filter-input-small {
      width: 80px;
    }

    /* é¢„è§ˆé¢æ¿ */
    .preview-card {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
    }

    .preview-section {
      margin-bottom: var(--space-5);
    }

    .preview-section:last-child {
      margin-bottom: 0;
    }

    .preview-section-title {
      font-size: 14px;
      color: var(--secondary);
      margin-bottom: var(--space-3);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-2) 0;
      border-bottom: 1px dashed var(--gray-3);
    }

    .stat-item:last-child {
      border-bottom: none;
    }

    .stat-label {
      color: var(--text);
    }

    .stat-value {
      font-weight: 600;
      color: var(--heading);
    }

    .estimate-box {
      background: linear-gradient(135deg, var(--primary-1) 0%, var(--primary-2) 100%);
      border: 1px solid var(--primary-3);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      text-align: center;
    }

    .estimate-label {
      font-size: 12px;
      color: var(--secondary);
      margin-bottom: var(--space-1);
    }

    .estimate-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-6);
      line-height: 1;
    }

    .estimate-unit {
      font-size: 14px;
      color: var(--secondary);
      margin-top: var(--space-1);
    }

    /* æ“ä½œæ  */
    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-6);
      padding: var(--space-4) var(--space-6);
      background: var(--white);
      border-radius: var(--radius-lg);
      position: sticky;
      bottom: var(--space-4);
      box-shadow: var(--shadow-lg);
    }

    /* éª¨æ¶å± */
    .skeleton {
      background: linear-gradient(90deg, var(--gray-2) 25%, var(--gray-3) 50%, var(--gray-2) 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.5s ease-in-out infinite;
    }

    @keyframes skeleton-loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-item {
      height: 50px;
      margin-bottom: 8px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <h1 class="page-title">æ•°æ®ç»´åº¦é€‰æ‹©</h1>
      <div class="flex gap-3">
        <button class="btn btn-default" onclick="goBack()">â† è¿”å›</button>
        <button class="btn btn-default" onclick="saveAsDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="page-content">
      <div class="selection-container fade-in">
        <!-- å·¦ä¾§é…ç½®åŒº -->
        <div class="selection-left">
          <!-- 1ï¸âƒ£ é€‰æ‹©ä¸»ä½“ -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>1ï¸âƒ£ é€‰æ‹©ä¸»ä½“ <span style="color: var(--error);">*</span></span>
              <span class="dimension-count-badge" id="subjectCountBadge">å·²é€‰ 0</span>
            </div>

            <!-- å·²é€‰é¡¹ -->
            <div class="selected-area">
              <div class="selected-header">
                <span class="selected-label">å·²é€‰é¡¹</span>
                <span class="selected-clear" onclick="clearSubjects()">æ¸…ç©º</span>
              </div>
              <div class="selection-tags" id="selectedSubjects"></div>
            </div>

            <!-- æœç´¢æ¡† -->
            <div class="search-box">
              <input type="text" id="subjectSearch" class="search-input" placeholder="æœç´¢ä¸»ä½“åç§°...">
              <span class="search-clear" id="subjectSearchClear" onclick="clearSubjectSearch()">Ã—</span>
              <span class="search-icon">ğŸ”</span>
            </div>

            <!-- åˆ—è¡¨ -->
            <div class="list-container" id="subjectList"></div>

            <div class="list-footer">
              <span id="subjectLoadInfo">å·²åŠ è½½ 0 ä¸ªä¸»ä½“</span>
            </div>
          </div>

          <!-- 2ï¸âƒ£ ç­›é€‰è´¦æˆ· -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>2ï¸âƒ£ ç­›é€‰è´¦æˆ·ï¼ˆå¯é€‰ï¼‰</span>
              <span class="dimension-count-badge" id="accountCountBadge">ç¬¦åˆ 0 ä¸ª</span>
            </div>

            <div class="filter-section">
              <div class="filter-row">
                <input type="checkbox" id="filterConversion">
                <label for="filterConversion">è½¬åŒ–æ•°é‡ ></label>
                <input type="number" id="conversionMin" class="input filter-input-small" value="6" min="0">
              </div>
              <div class="filter-row">
                <input type="checkbox" id="filterOpenDays">
                <label for="filterOpenDays">å¼€æˆ·å¤©æ•° <</label>
                <input type="number" id="openDaysMax" class="input filter-input-small" value="5" min="0">
              </div>
              <div class="filter-row">
                <input type="checkbox" id="filterAccountStatus">
                <label for="filterAccountStatus">è´¦æˆ·çŠ¶æ€ï¼š</label>
                <select id="accountStatus" class="input">
                  <option value="running">è·‘é‡</option>
                  <option value="testing">æµ‹è¯•</option>
                </select>
              </div>
            </div>

            <div style="font-size: 12px; color: var(--secondary); margin-top: var(--space-2);">
              ğŸ’¡ æç¤ºï¼šç­›é€‰æ¡ä»¶å°†åº”ç”¨äºå·²é€‰ä¸»ä½“ä¸‹çš„æ‰€æœ‰è´¦æˆ·
            </div>
          </div>

          <!-- 3ï¸âƒ£ é€‰æ‹©é¡¹ç›® -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>3ï¸âƒ£ é€‰æ‹©é¡¹ç›® <span style="color: var(--error);">*</span></span>
              <span class="dimension-count-badge" id="projectCountBadge">å·²é€‰ 0</span>
            </div>

            <div class="selected-area">
              <div class="selected-header">
                <span class="selected-label">å·²é€‰é¡¹</span>
                <span class="selected-clear" onclick="clearProjects()">æ¸…ç©º</span>
              </div>
              <div class="selection-tags" id="selectedProjects"></div>
            </div>

            <div class="search-box">
              <input type="text" id="projectSearch" class="search-input" placeholder="æœç´¢é¡¹ç›®åç§°ï¼ˆæ”¯æŒ2000+é¡¹ç›®ï¼‰...">
              <span class="search-clear" id="projectSearchClear" onclick="clearProjectSearch()">Ã—</span>
              <span class="search-icon">ğŸ”</span>
            </div>

            <div class="list-container" id="projectList"></div>

            <div class="list-footer">
              <span id="projectLoadInfo">å·²åŠ è½½ 0 / 2000+ ä¸ªé¡¹ç›®</span>
              <span class="load-more-btn" id="projectLoadMore" onclick="loadMoreProjects()">åŠ è½½æ›´å¤š</span>
            </div>
          </div>

          <!-- 4ï¸âƒ£ é€‰æ‹©å°è¯´ -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>4ï¸âƒ£ é€‰æ‹©å°è¯´ <span style="color: var(--error);">*</span></span>
              <span class="dimension-count-badge" id="bookCountBadge">å·²é€‰ 0</span>
            </div>

            <div class="selected-area">
              <div class="selected-header">
                <span class="selected-label">å·²é€‰é¡¹</span>
                <span class="selected-clear" onclick="clearBooks()">æ¸…ç©º</span>
              </div>
              <div class="selection-tags" id="selectedBooks"></div>
            </div>

            <div class="search-box">
              <input type="text" id="bookSearch" class="search-input" placeholder="æœç´¢å°è¯´æ ‡é¢˜ï¼ˆæ”¯æŒ10000+å°è¯´ï¼‰...">
              <span class="search-clear" id="bookSearchClear" onclick="clearBookSearch()">Ã—</span>
              <span class="search-icon">ğŸ”</span>
            </div>

            <div class="list-container" id="bookList"></div>

            <div class="list-footer">
              <span id="bookLoadInfo">è¾“å…¥å…³é”®è¯æœç´¢</span>
            </div>
          </div>

          <!-- 5ï¸âƒ£ é€‰æ‹©ç´ æ -->
          <div class="dimension-section">
            <div class="dimension-title">
              <span>5ï¸âƒ£ é€‰æ‹©ç´ æ <span style="color: var(--error);">*</span></span>
              <span class="dimension-count-badge" id="materialCountBadge">å·²é€‰ 0</span>
            </div>

            <div class="filter-section">
              <div style="margin-bottom: var(--space-2); font-weight: 500;">ç´ æç±»å‹ï¼š</div>
              <div style="display: flex; gap: var(--space-4);">
                <label>
                  <input type="checkbox" id="materialDecompress" checked onchange="updateMaterialTypes()">
                  è§£å‹
                </label>
                <label>
                  <input type="checkbox" id="materialScroll" checked onchange="updateMaterialTypes()">
                  æ»šå±
                </label>
                <label>
                  <input type="checkbox" id="materialAdx" checked onchange="updateMaterialTypes()">
                  ADX
                </label>
              </div>
            </div>

            <div class="selected-area">
              <div class="selected-header">
                <span class="selected-label">å·²é€‰ç´ æç±»å‹</span>
              </div>
              <div id="selectedMaterialTypes" style="font-size: 14px; color: var(--text);"></div>
            </div>

            <div style="font-size: 12px; color: var(--secondary); margin-top: var(--space-2);">
              ğŸ’¡ æç¤ºï¼šç³»ç»Ÿå°†æ ¹æ®è§„åˆ™è‡ªåŠ¨åˆ†é…æ‰€é€‰ç±»å‹çš„ç´ æ
            </div>
          </div>
        </div>

        <!-- å³ä¾§é¢„è§ˆé¢æ¿ -->
        <div class="selection-right">
          <div class="preview-card">
            <div class="preview-section">
              <div class="preview-section-title">
                <span>ğŸ“Š</span>
                <span>é€‰æ‹©æ±‡æ€»</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ä¸»ä½“æ•°é‡</span>
                <span class="stat-value" id="previewSubjects">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">è´¦æˆ·æ•°é‡</span>
                <span class="stat-value" id="previewAccounts">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">é¡¹ç›®æ•°é‡</span>
                <span class="stat-value" id="previewProjects">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">å°è¯´æ•°é‡</span>
                <span class="stat-value" id="previewBooks">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">ç´ æç±»å‹</span>
                <span class="stat-value" id="previewMaterials">0</span>
              </div>
            </div>

            <div class="preview-section">
              <div class="preview-section-title">
                <span>ğŸ’¡</span>
                <span>ç”Ÿæˆé¢„ä¼°</span>
              </div>
              <div class="estimate-box">
                <div class="estimate-label">æ ¹æ®å½“å‰é€‰æ‹©</div>
                <div class="estimate-value" id="estimatedCount">0</div>
                <div class="estimate-unit">æ¡å¹¿å‘Šè®¡åˆ’</div>
              </div>
              <div style="margin-top: var(--space-3); font-size: 12px; color: var(--secondary); text-align: center;">
                âš ï¸ å…·ä½“æ•°é‡ä»¥è§„åˆ™é…ç½®ä¸ºå‡†
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="action-bar">
        <button class="btn btn-default" onclick="goBack()">â† å–æ¶ˆ</button>
        <button class="btn btn-primary" id="nextBtn" disabled onclick="nextStep()">ä¸‹ä¸€æ­¥ï¼šé…ç½®è§„åˆ™ â†’</button>
      </div>
    </div>
  </div>

  <script src="js/main.js"></script>
  <script src="js/performance-utils.js"></script>
  <script>
    // å…¨å±€æ•°æ®
    let selectedData = {
      subjects: [],
      accounts: [],
      projects: [],
      books: [],
      materials: []
    };

    // é€‰æ‹©ç®¡ç†å™¨
    let subjectManager, projectManager, bookManager;

    // è™šæ‹Ÿæ»šåŠ¨å®ä¾‹
    let projectVirtualScroll;

    // æœç´¢å®ä¾‹
    let projectSearcher, bookSearcher;

    // æ¨¡æ‹Ÿå¤§é‡æ•°æ®
    const mockData = generateMockData();

    // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
    function generateMockData() {
      const data = {
        subjects: [],
        accounts: [],
        projects: [],
        books: [],
        materials: []
      };

      // ç”Ÿæˆ50ä¸ªä¸»ä½“
      for (let i = 1; i <= 50; i++) {
        data.subjects.push({
          id: 'SUB' + String(i).padStart(3, '0'),
          name: `ä¸»ä½“${i}`,
          type: i <= 30 ? 'running' : 'testing',
          accountCount: Math.floor(Math.random() * 10) + 1,
          conversionCount: Math.floor(Math.random() * 200)
        });
      }

      // ç”Ÿæˆ2000ä¸ªé¡¹ç›®
      const categories = ['éœ¸é“æ€»è£', 'ç©¿è¶Šé‡ç”Ÿ', 'éƒ½å¸‚è¨€æƒ…', 'å¤ä»£è¨€æƒ…', 'ç„å¹»ä¿®ä»™', 'æ‚¬ç–‘æ¨ç†'];
      for (let i = 1; i <= 2000; i++) {
        data.projects.push({
          id: 'PRJ' + String(i).padStart(4, '0'),
          name: `é¡¹ç›®${i} - ${categories[i % categories.length]}`,
          category: categories[i % categories.length]
        });
      }

      // ç”Ÿæˆ10000ä¸ªå°è¯´ï¼ˆæœç´¢æ—¶åŠ¨æ€ç”Ÿæˆï¼‰
      // ...

      // ç”Ÿæˆç´ æç±»å‹
      data.materials = [
        { id: 'MAT_TYPE_1', type: 'decompress', name: 'è§£å‹ç´ æ' },
        { id: 'MAT_TYPE_2', type: 'scroll', name: 'æ»šå±ç´ æ' },
        { id: 'MAT_TYPE_3', type: 'adx', name: 'ADXç´ æ' }
      ];

      return data;
    }

    // åˆå§‹åŒ–
    function init() {
      // åˆå§‹åŒ–é€‰æ‹©ç®¡ç†å™¨
      subjectManager = new SelectionManager({
        container: document.getElementById('selectedSubjects'),
        idKey: 'id',
        labelKey: 'name',
        maxDisplay: 10,
        onChange: (items) => {
          selectedData.subjects = items;
          updateSubjectBadge();
          updateAccountFilters();
          updatePreview();
          validateForm();
        }
      });

      projectManager = new SelectionManager({
        container: document.getElementById('selectedProjects'),
        idKey: 'id',
        labelKey: 'name',
        maxDisplay: 10,
        onChange: (items) => {
          selectedData.projects = items;
          updateProjectBadge();
          updatePreview();
          validateForm();
        }
      });

      bookManager = new SelectionManager({
        container: document.getElementById('selectedBooks'),
        idKey: 'id',
        labelKey: 'name',
        maxDisplay: 10,
        onChange: (items) => {
          selectedData.books = items;
          updateBookBadge();
          updatePreview();
          validateForm();
        }
      });

      // åˆå§‹åŒ–ä¸»ä½“åˆ—è¡¨
      renderSubjectList(mockData.subjects);

      // åˆå§‹åŒ–é¡¹ç›®è™šæ‹Ÿæ»šåŠ¨
      initProjectVirtualScroll();

      // åˆå§‹åŒ–æœç´¢
      initSearch();

      // åˆå§‹åŒ–ç´ æ
      updateMaterialTypes();

      // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
      document.getElementById('filterConversion').addEventListener('change', updateAccountFilters);
      document.getElementById('filterOpenDays').addEventListener('change', updateAccountFilters);
      document.getElementById('filterAccountStatus').addEventListener('change', updateAccountFilters);
      document.getElementById('conversionMin').addEventListener('input', updateAccountFilters);
      document.getElementById('openDaysMax').addEventListener('input', updateAccountFilters);
    }

    // æ¸²æŸ“ä¸»ä½“åˆ—è¡¨
    function renderSubjectList(subjects) {
      const container = document.getElementById('subjectList');
      container.innerHTML = '';

      subjects.forEach(subject => {
        const item = document.createElement('div');
        item.className = 'list-item';
        if (subjectManager.has(subject.id)) {
          item.classList.add('selected');
        }

        item.innerHTML = `
          <input type="checkbox" class="list-item-checkbox" ${subjectManager.has(subject.id) ? 'checked' : ''}>
          <div class="list-item-info">
            <div class="list-item-name">${subject.name}</div>
            <div class="list-item-meta">
              ${subject.type === 'running' ? 'è·‘é‡' : 'æµ‹è¯•'} Â·
              è´¦æˆ·:${subject.accountCount} Â·
              è½¬åŒ–:${subject.conversionCount}
            </div>
          </div>
        `;

        item.addEventListener('click', () => {
          subjectManager.toggle(subject);
          renderSubjectList(mockData.subjects);
        });

        container.appendChild(item);
      });

      document.getElementById('subjectLoadInfo').textContent = `å…± ${subjects.length} ä¸ªä¸»ä½“`;
    }

    // åˆå§‹åŒ–é¡¹ç›®è™šæ‹Ÿæ»šåŠ¨
    function initProjectVirtualScroll() {
      const container = document.getElementById('projectList');

      projectVirtualScroll = new VirtualScroll({
        container: container,
        items: mockData.projects.slice(0, 100), // é¦–æ¬¡åŠ è½½100æ¡
        itemHeight: 50,
        buffer: 5,
        renderItem: (project, index) => {
          const item = document.createElement('div');
          item.className = 'list-item';
          if (projectManager.has(project.id)) {
            item.classList.add('selected');
          }

          item.innerHTML = `
            <input type="checkbox" class="list-item-checkbox" ${projectManager.has(project.id) ? 'checked' : ''}>
            <div class="list-item-info">
              <div class="list-item-name">${project.name}</div>
              <div class="list-item-meta">${project.category}</div>
            </div>
          `;

          return item;
        },
        onItemClick: (project) => {
          projectManager.toggle(project);
          projectVirtualScroll.render(); // é‡æ–°æ¸²æŸ“
        }
      });

      document.getElementById('projectLoadInfo').textContent = `å·²åŠ è½½ 100 / 2000+ ä¸ªé¡¹ç›®`;
    }

    // åŠ è½½æ›´å¤šé¡¹ç›®
    function loadMoreProjects() {
      const currentLength = projectVirtualScroll.items.length;
      const nextBatch = mockData.projects.slice(currentLength, currentLength + 100);

      if (nextBatch.length === 0) {
        document.getElementById('projectLoadMore').textContent = 'å·²åŠ è½½å…¨éƒ¨';
        document.getElementById('projectLoadMore').classList.add('loading');
        return;
      }

      projectVirtualScroll.update([...projectVirtualScroll.items, ...nextBatch]);
      document.getElementById('projectLoadInfo').textContent =
        `å·²åŠ è½½ ${projectVirtualScroll.items.length} / 2000+ ä¸ªé¡¹ç›®`;

      Message.success(`å·²åŠ è½½ ${nextBatch.length} ä¸ªé¡¹ç›®`);
    }

    // åˆå§‹åŒ–æœç´¢
    function initSearch() {
      // é¡¹ç›®æœç´¢
      projectSearcher = new SmartSearch({
        searchFn: (query) => {
          return new Promise((resolve) => {
            setTimeout(() => {
              const results = mockData.projects.filter(p =>
                p.name.toLowerCase().includes(query) ||
                p.category.toLowerCase().includes(query)
              );
              resolve(results);
            }, 300);
          });
        },
        debounceMs: 500
      });

      const projectSearchInput = document.getElementById('projectSearch');
      projectSearchInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();

        document.getElementById('projectSearchClear').classList.toggle('active', query.length > 0);

        if (query.length === 0) {
          // æ¢å¤åŸå§‹åˆ—è¡¨
          projectVirtualScroll.update(mockData.projects.slice(0, 100));
          document.getElementById('projectLoadInfo').textContent = 'å·²åŠ è½½ 100 / 2000+ ä¸ªé¡¹ç›®';
          document.getElementById('projectLoadMore').style.display = 'inline';
          return;
        }

        const results = await projectSearcher.search(query);
        if (results) {
          projectVirtualScroll.update(results);
          document.getElementById('projectLoadInfo').textContent = `æœç´¢åˆ° ${results.length} ä¸ªé¡¹ç›®`;
          document.getElementById('projectLoadMore').style.display = 'none';
        }
      });

      // å°è¯´æœç´¢
      bookSearcher = new SmartSearch({
        searchFn: (query) => {
          return new Promise((resolve) => {
            setTimeout(() => {
              // æ¨¡æ‹Ÿç”Ÿæˆæœç´¢ç»“æœ
              const results = [];
              for (let i = 1; i <= 50; i++) {
                results.push({
                  id: 'BOOK' + Date.now() + i,
                  name: `ã€Š${query}ç›¸å…³å°è¯´${i}ã€‹`,
                  author: `ä½œè€…${i}`
                });
              }
              resolve(results);
            }, 300);
          });
        },
        debounceMs: 500
      });

      const bookSearchInput = document.getElementById('bookSearch');
      bookSearchInput.addEventListener('input', async (e) => {
        const query = e.target.value.trim();

        document.getElementById('bookSearchClear').classList.toggle('active', query.length > 0);

        if (query.length === 0) {
          document.getElementById('bookList').innerHTML = '<div class="list-empty">è¯·è¾“å…¥å…³é”®è¯æœç´¢å°è¯´</div>';
          document.getElementById('bookLoadInfo').textContent = 'è¾“å…¥å…³é”®è¯æœç´¢';
          return;
        }

        if (query.length < 2) {
          return;
        }

        document.getElementById('bookList').innerHTML = '<div class="list-loading">æœç´¢ä¸­...</div>';

        const results = await bookSearcher.search(query);
        if (results && results.length > 0) {
          renderBookList(results);
          document.getElementById('bookLoadInfo').textContent = `æœç´¢åˆ° ${results.length} ä¸ªç»“æœ`;
        } else {
          document.getElementById('bookList').innerHTML = '<div class="list-empty">æœªæ‰¾åˆ°ç›¸å…³å°è¯´</div>';
          document.getElementById('bookLoadInfo').textContent = 'æœªæ‰¾åˆ°ç»“æœ';
        }
      });
    }

    // æ¸²æŸ“å°è¯´åˆ—è¡¨
    function renderBookList(books) {
      const container = document.getElementById('bookList');
      container.innerHTML = '';

      books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'list-item';
        if (bookManager.has(book.id)) {
          item.classList.add('selected');
        }

        item.innerHTML = `
          <input type="checkbox" class="list-item-checkbox" ${bookManager.has(book.id) ? 'checked' : ''}>
          <div class="list-item-info">
            <div class="list-item-name">${book.name}</div>
            <div class="list-item-meta">${book.author || 'æœªçŸ¥ä½œè€…'}</div>
          </div>
        `;

        item.addEventListener('click', () => {
          bookManager.toggle(book);
          renderBookList(books);
        });

        container.appendChild(item);
      });
    }

    // æ¸…é™¤æœç´¢
    function clearProjectSearch() {
      document.getElementById('projectSearch').value = '';
      document.getElementById('projectSearchClear').classList.remove('active');
      projectVirtualScroll.update(mockData.projects.slice(0, 100));
      document.getElementById('projectLoadInfo').textContent = 'å·²åŠ è½½ 100 / 2000+ ä¸ªé¡¹ç›®';
      document.getElementById('projectLoadMore').style.display = 'inline';
    }

    function clearBookSearch() {
      document.getElementById('bookSearch').value = '';
      document.getElementById('bookSearchClear').classList.remove('active');
      document.getElementById('bookList').innerHTML = '<div class="list-empty">è¯·è¾“å…¥å…³é”®è¯æœç´¢å°è¯´</div>';
      document.getElementById('bookLoadInfo').textContent = 'è¾“å…¥å…³é”®è¯æœç´¢';
    }

    function clearSubjectSearch() {
      document.getElementById('subjectSearch').value = '';
      document.getElementById('subjectSearchClear').classList.remove('active');
    }

    // æ›´æ–°è´¦æˆ·ç­›é€‰
    function updateAccountFilters() {
      // æ¨¡æ‹Ÿç­›é€‰é€»è¾‘
      const useConversion = document.getElementById('filterConversion').checked;
      const useOpenDays = document.getElementById('filterOpenDays').checked;
      const useStatus = document.getElementById('filterAccountStatus').checked;

      const conversionMin = parseInt(document.getElementById('conversionMin').value) || 0;

      // ç®€åŒ–è®¡ç®—ï¼šæ¯ä¸ªä¸»ä½“å¹³å‡5ä¸ªè´¦æˆ·ï¼Œ50%ç¬¦åˆæ¡ä»¶
      let accountCount = selectedData.subjects.length * 5;
      if (useConversion || useOpenDays || useStatus) {
        accountCount = Math.floor(accountCount * 0.5);
      }

      selectedData.accounts = Array(accountCount).fill({});

      document.getElementById('accountCountBadge').textContent = `ç¬¦åˆ ${accountCount} ä¸ª`;
      document.getElementById('previewAccounts').textContent = accountCount;
    }

    // æ›´æ–°ç´ æç±»å‹
    function updateMaterialTypes() {
      const types = [];
      if (document.getElementById('materialDecompress').checked) types.push('è§£å‹');
      if (document.getElementById('materialScroll').checked) types.push('æ»šå±');
      if (document.getElementById('materialAdx').checked) types.push('ADX');

      selectedData.materials = mockData.materials.filter(m => {
        if (m.type === 'decompress') return document.getElementById('materialDecompress').checked;
        if (m.type === 'scroll') return document.getElementById('materialScroll').checked;
        if (m.type === 'adx') return document.getElementById('materialAdx').checked;
        return false;
      });

      document.getElementById('selectedMaterialTypes').textContent =
        types.length > 0 ? types.join('ã€') : 'æœªé€‰æ‹©';
      document.getElementById('materialCountBadge').textContent = `å·²é€‰ ${types.length} ç±»`;
      document.getElementById('previewMaterials').textContent = types.length + ' ç±»';

      validateForm();
    }

    // æ›´æ–°å¾½ç« 
    function updateSubjectBadge() {
      document.getElementById('subjectCountBadge').textContent = `å·²é€‰ ${selectedData.subjects.length}`;
    }

    function updateProjectBadge() {
      document.getElementById('projectCountBadge').textContent = `å·²é€‰ ${selectedData.projects.length}`;
    }

    function updateBookBadge() {
      document.getElementById('bookCountBadge').textContent = `å·²é€‰ ${selectedData.books.length}`;
    }

    // æ›´æ–°é¢„è§ˆ
    function updatePreview() {
      document.getElementById('previewSubjects').textContent = selectedData.subjects.length;
      document.getElementById('previewProjects').textContent = selectedData.projects.length;
      document.getElementById('previewBooks').textContent = selectedData.books.length;
    }

    // æ¸…ç©ºé€‰æ‹©
    function clearSubjects() {
      subjectManager.clear();
      renderSubjectList(mockData.subjects);
    }

    function clearProjects() {
      projectManager.clear();
      projectVirtualScroll.render();
    }

    function clearBooks() {
      bookManager.clear();
      clearBookSearch();
    }

    // è¡¨å•éªŒè¯
    function validateForm() {
      const isValid =
        selectedData.subjects.length > 0 &&
        selectedData.projects.length > 0 &&
        selectedData.books.length > 0 &&
        selectedData.materials.length > 0;

      document.getElementById('nextBtn').disabled = !isValid;
    }

    // è¿”å›
    function goBack() {
      window.location.href = 'create-new.html';
    }

    // ä¿å­˜è‰ç¨¿
    function saveAsDraft() {
      DataStore.save('selectedDimensions', selectedData);
      Message.success('è‰ç¨¿å·²ä¿å­˜');
    }

    // ä¸‹ä¸€æ­¥
    function nextStep() {
      if (!validateForm()) {
        Message.error('è¯·å®Œæˆæ‰€æœ‰å¿…å¡«é¡¹');
        return;
      }

      DataStore.save('selectedDimensions', selectedData);
      Message.success('æ•°æ®å·²ä¿å­˜ï¼Œæ­£åœ¨è·³è½¬...');

      setTimeout(() => {
        window.location.href = 'rule-config.html';
      }, 500);
    }

    // é¡µé¢åŠ è½½
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
