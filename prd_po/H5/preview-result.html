<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¢„è§ˆç”Ÿæˆç»“æœ - å¹¿å‘Šæ‰¹é‡åˆ›ç¼–</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    .preview-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }

    .summary-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 32px;
      margin-bottom: 24px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 24px;
      margin-top: 20px;
    }

    .summary-card {
      text-align: center;
      padding: 16px;
      background: var(--gray-1);
      border-radius: var(--radius-md);
    }

    .summary-label {
      font-size: 12px;
      color: var(--secondary);
      margin-bottom: 8px;
    }

    .summary-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary-6);
    }

    .result-section {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--heading);
    }

    .toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .filter-bar {
      display: flex;
      gap: 12px;
      flex: 1;
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .result-table th {
      background: var(--gray-1);
      padding: 12px 16px;
      text-align: left;
      font-weight: 600;
      color: var(--heading);
      border-bottom: 2px solid var(--gray-3);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .result-table th input[type="checkbox"] {
      cursor: pointer;
    }

    .result-table td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-2);
    }

    .result-table tbody tr:hover {
      background: var(--primary-1);
    }

    .ad-name {
      color: var(--primary-6);
      font-weight: 500;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 2px;
      font-size: 12px;
      font-weight: 500;
    }

    .tag-decompress {
      background: var(--success-1);
      color: var(--success-7);
    }

    .tag-scroll {
      background: var(--warning-1);
      color: var(--warning-7);
    }

    .tag-adx {
      background: var(--purple-1);
      color: var(--purple-7);
    }

    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--gray-2);
    }

    .batch-actions {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: var(--gray-1);
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }

    .action-bar {
      display: flex;
      justify-content: space-between;
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid var(--gray-2);
    }

    .detail-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .detail-modal.active {
      display: flex;
    }

    .detail-content {
      background: var(--white);
      border-radius: var(--radius-lg);
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--gray-2);
    }

    .detail-section {
      margin-bottom: 24px;
    }

    .detail-section h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--heading);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px dashed var(--gray-2);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .detail-label {
      color: var(--secondary);
      font-size: 14px;
    }

    .detail-value {
      font-weight: 500;
      color: var(--heading);
    }

    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }

    .loading-overlay.active {
      display: flex;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--gray-3);
      border-top-color: var(--primary-6);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
      <h1 class="page-title">é¢„è§ˆç”Ÿæˆç»“æœ</h1>
      <div class="flex gap-3">
        <button class="btn btn-default" onclick="goBack()">â† è¿”å›</button>
      </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="preview-container fade-in">
      <!-- ç”Ÿæˆæ‘˜è¦ -->
      <div class="summary-section">
        <h2 class="section-title">ğŸ“Š ç”Ÿæˆæ‘˜è¦</h2>
        <div class="summary-grid">
          <div class="summary-card">
            <div class="summary-label">é¢„è®¡ç”Ÿæˆ</div>
            <div class="summary-value" id="totalCount">0</div>
            <div class="summary-label">æ¡å¹¿å‘Šè®¡åˆ’</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">æ¶‰åŠä¸»ä½“</div>
            <div class="summary-value" id="subjectCount">0</div>
            <div class="summary-label">ä¸ª</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">æ¶‰åŠè´¦æˆ·</div>
            <div class="summary-value" id="accountCount">0</div>
            <div class="summary-label">ä¸ª</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">æ¶‰åŠé¡¹ç›®</div>
            <div class="summary-value" id="projectCount">0</div>
            <div class="summary-label">ä¸ª</div>
          </div>
          <div class="summary-card">
            <div class="summary-label">ä½¿ç”¨ç´ æ</div>
            <div class="summary-value" id="materialCount">0</div>
            <div class="summary-label">ä¸ª</div>
          </div>
        </div>
      </div>

      <!-- ç»“æœåˆ—è¡¨ -->
      <div class="result-section">
        <div class="section-header">
          <h2 class="section-title">ğŸ“‹ å¹¿å‘Šè®¡åˆ’åˆ—è¡¨</h2>
          <div class="flex gap-2">
            <button class="btn btn-default btn-small" onclick="exportExcel()">ğŸ“Š å¯¼å‡ºExcel</button>
            <button class="btn btn-default btn-small" onclick="refreshResults()">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>

        <!-- å·¥å…·æ  -->
        <div class="toolbar">
          <div class="filter-bar">
            <select id="filterSubject" class="input" onchange="filterResults()">
              <option value="">å…¨éƒ¨ä¸»ä½“</option>
            </select>
            <select id="filterMaterialType" class="input" onchange="filterResults()">
              <option value="">å…¨éƒ¨ç´ æç±»å‹</option>
              <option value="decompress">è§£å‹</option>
              <option value="scroll">æ»šå±</option>
              <option value="adx">ADX</option>
            </select>
            <input type="text" id="searchInput" class="input" placeholder="æœç´¢è®¡åˆ’åç§°..." onkeyup="debounceSearch()">
          </div>
        </div>

        <!-- æ‰¹é‡æ“ä½œ -->
        <div class="batch-actions" id="batchActions" style="display: none;">
          <span>å·²é€‰æ‹© <strong id="selectedCount">0</strong> æ¡</span>
          <button class="btn btn-default btn-small" onclick="deleteSelected()">åˆ é™¤é€‰ä¸­</button>
          <button class="btn btn-default btn-small" onclick="modifySelected()">ä¿®æ”¹é…ç½®</button>
          <button class="btn btn-default btn-small" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
        </div>

        <!-- è¡¨æ ¼ -->
        <div style="overflow-x: auto;">
          <table class="result-table">
            <thead>
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                </th>
                <th>ä¸»ä½“</th>
                <th>è´¦æˆ·</th>
                <th>é¡¹ç›®</th>
                <th>å°è¯´</th>
                <th>ç´ æç±»å‹</th>
                <th>å¹¿å‘Šè®¡åˆ’åç§°</th>
                <th style="width: 100px;">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="resultTableBody">
              <!-- æ•°æ®å°†åŠ¨æ€å¡«å…… -->
            </tbody>
          </table>
        </div>

        <!-- åˆ†é¡µ -->
        <div class="pagination">
          <div class="text-secondary">
            æ˜¾ç¤º <span id="rangeStart">1</span>-<span id="rangeEnd">20</span>ï¼Œå…± <span id="totalRecords">0</span> æ¡
          </div>
          <div class="flex gap-2">
            <button class="btn btn-default btn-small" id="prevPage" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
            <button class="btn btn-default btn-small" id="nextPage" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="action-bar">
        <button class="btn btn-default" onclick="goBack()">â† ä¸Šä¸€æ­¥</button>
        <div class="flex gap-3">
          <button class="btn btn-default" onclick="saveAsDraft()">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
          <button class="btn btn-primary" onclick="submitCreation()">âœ… æäº¤åˆ›å»º</button>
        </div>
      </div>
    </div>
  </div>

  <!-- è¯¦æƒ…å¼¹çª— -->
  <div class="detail-modal" id="detailModal">
    <div class="detail-content">
      <div class="detail-header">
        <h3>å¹¿å‘Šè®¡åˆ’è¯¦æƒ…</h3>
        <button class="btn btn-text" onclick="closeDetail()">âœ•</button>
      </div>

      <div class="detail-section">
        <h4>ğŸ“‹ åŸºç¡€ä¿¡æ¯</h4>
        <div class="detail-row">
          <span class="detail-label">ä¸»ä½“</span>
          <span class="detail-value" id="detailSubject"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">è´¦æˆ·</span>
          <span class="detail-value" id="detailAccount"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">é¡¹ç›®</span>
          <span class="detail-value" id="detailProject"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">å°è¯´</span>
          <span class="detail-value" id="detailBook"></span>
        </div>
      </div>

      <div class="detail-section">
        <h4>ğŸ¨ åˆ›æ„ä¿¡æ¯</h4>
        <div class="detail-row">
          <span class="detail-label">ç´ æç±»å‹</span>
          <span class="detail-value" id="detailMaterialType"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ç´ ææ¥æº</span>
          <span class="detail-value" id="detailMaterialSource"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">è®¡åˆ’åç§°</span>
          <span class="detail-value" id="detailName"></span>
        </div>
      </div>

      <div class="detail-section">
        <h4>âš™ï¸ æŠ•æ”¾é…ç½®</h4>
        <div class="detail-row">
          <span class="detail-label">æ—¥é¢„ç®—</span>
          <span class="detail-value" id="detailBudget"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">å‡ºä»·</span>
          <span class="detail-value" id="detailBidding"></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">æŠ•æ”¾æ—¶æ®µ</span>
          <span class="detail-value" id="detailSchedule"></span>
        </div>
      </div>

      <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
        <button class="btn btn-default" onclick="closeDetail()">å…³é—­</button>
        <button class="btn btn-danger" onclick="deleteItem()">åˆ é™¤</button>
        <button class="btn btn-primary" onclick="editItem()">ç¼–è¾‘</button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½é®ç½© -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <p style="margin-top: 20px; color: var(--secondary);">æ­£åœ¨ç”Ÿæˆå¹¿å‘Šè®¡åˆ’...</p>
  </div>

  <script src="js/main.js"></script>
  <script src="js/generation-engine.js"></script>
  <script>
    let engine = new GenerationEngine();
    let allResults = [];
    let filteredResults = [];
    let selectedItems = new Set();
    let currentPage = 1;
    let pageSize = 20;
    let currentDetailItem = null;

    // åˆå§‹åŒ–
    function init() {
      // æ˜¾ç¤ºåŠ è½½é®ç½©
      document.getElementById('loadingOverlay').classList.add('active');

      setTimeout(() => {
        // åŠ è½½æ•°æ®
        const selectedDimensions = DataStore.load('selectedDimensions', {});
        const generationRules = DataStore.load('generationRules', null);

        if (!generationRules) {
          Message.error('æœªæ‰¾åˆ°ç”Ÿæˆè§„åˆ™é…ç½®');
          document.getElementById('loadingOverlay').classList.remove('active');
          return;
        }

        // è®¾ç½®å¼•æ“
        engine.setSelectedData(selectedDimensions);
        engine.setRules(generationRules);

        // ç”Ÿæˆç»“æœ
        allResults = engine.generate();
        filteredResults = [...allResults];

        // æ›´æ–°UI
        updateSummary(selectedDimensions);
        updateSubjectFilter(selectedDimensions.subjects);
        renderTable();

        document.getElementById('loadingOverlay').classList.remove('active');
        Message.success(`æˆåŠŸç”Ÿæˆ ${allResults.length} æ¡å¹¿å‘Šè®¡åˆ’`);
      }, 1000);
    }

    // æ›´æ–°æ‘˜è¦
    function updateSummary(dimensions) {
      const stats = engine.getStatistics();

      document.getElementById('totalCount').textContent = allResults.length;
      document.getElementById('subjectCount').textContent = stats.subjectCount;
      document.getElementById('accountCount').textContent = stats.filteredAccountCount || stats.accountCount;
      document.getElementById('projectCount').textContent = stats.projectCount;
      document.getElementById('materialCount').textContent = stats.materialCount;
    }

    // æ›´æ–°ä¸»ä½“ç­›é€‰å™¨
    function updateSubjectFilter(subjects) {
      const filterSubject = document.getElementById('filterSubject');
      subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        filterSubject.appendChild(option);
      });
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      const tbody = document.getElementById('resultTableBody');
      tbody.innerHTML = '';

      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, filteredResults.length);
      const pageResults = filteredResults.slice(start, end);

      if (pageResults.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: var(--secondary);">
              æš‚æ— æ•°æ®
            </td>
          </tr>
        `;
        return;
      }

      pageResults.forEach(item => {
        const row = document.createElement('tr');
        const isSelected = selectedItems.has(item.id);

        row.innerHTML = `
          <td>
            <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect('${item.id}')">
          </td>
          <td>${item.subjectName}</td>
          <td>${item.accountName}</td>
          <td>${item.projectName}</td>
          <td>${item.bookName}</td>
          <td>
            <span class="tag tag-${item.materialType}">
              ${getTypeName(item.materialType)}
            </span>
          </td>
          <td class="ad-name">${item.name}</td>
          <td>
            <button class="btn btn-text btn-small" onclick="viewDetail('${item.id}')">æŸ¥çœ‹</button>
          </td>
        `;

        tbody.appendChild(row);
      });

      // æ›´æ–°åˆ†é¡µä¿¡æ¯
      document.getElementById('rangeStart').textContent = start + 1;
      document.getElementById('rangeEnd').textContent = end;
      document.getElementById('totalRecords').textContent = filteredResults.length;

      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = end >= filteredResults.length;
    }

    // è·å–ç±»å‹åç§°
    function getTypeName(type) {
      const typeMap = {
        decompress: 'è§£å‹',
        scroll: 'æ»šå±',
        adx: 'ADX'
      };
      return typeMap[type] || type;
    }

    // ç­›é€‰ç»“æœ
    function filterResults() {
      const subjectFilter = document.getElementById('filterSubject').value;
      const materialTypeFilter = document.getElementById('filterMaterialType').value;
      const searchText = document.getElementById('searchInput').value.toLowerCase();

      filteredResults = allResults.filter(item => {
        if (subjectFilter && item.subjectId !== subjectFilter) return false;
        if (materialTypeFilter && item.materialType !== materialTypeFilter) return false;
        if (searchText && !item.name.toLowerCase().includes(searchText)) return false;
        return true;
      });

      currentPage = 1;
      renderTable();
    }

    // é˜²æŠ–æœç´¢
    let searchTimer;
    function debounceSearch() {
      clearTimeout(searchTimer);
      searchTimer = setTimeout(filterResults, 300);
    }

    // åˆ‡æ¢å…¨é€‰
    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      const start = (currentPage - 1) * pageSize;
      const end = Math.min(start + pageSize, filteredResults.length);
      const pageResults = filteredResults.slice(start, end);

      pageResults.forEach(item => {
        if (checked) {
          selectedItems.add(item.id);
        } else {
          selectedItems.delete(item.id);
        }
      });

      renderTable();
      updateBatchActions();
    }

    // åˆ‡æ¢é€‰æ‹©
    function toggleSelect(id) {
      if (selectedItems.has(id)) {
        selectedItems.delete(id);
      } else {
        selectedItems.add(id);
      }
      updateBatchActions();
    }

    // æ›´æ–°æ‰¹é‡æ“ä½œæ 
    function updateBatchActions() {
      const count = selectedItems.size;
      document.getElementById('selectedCount').textContent = count;
      document.getElementById('batchActions').style.display = count > 0 ? 'flex' : 'none';
    }

    // æ¸…é™¤é€‰æ‹©
    function clearSelection() {
      selectedItems.clear();
      document.getElementById('selectAll').checked = false;
      renderTable();
      updateBatchActions();
    }

    // åˆ é™¤é€‰ä¸­
    function deleteSelected() {
      if (selectedItems.size === 0) return;

      if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${selectedItems.size} æ¡å¹¿å‘Šè®¡åˆ’å—ï¼Ÿ`)) {
        allResults = allResults.filter(item => !selectedItems.has(item.id));
        filteredResults = filteredResults.filter(item => !selectedItems.has(item.id));
        selectedItems.clear();
        renderTable();
        updateBatchActions();
        Message.success('åˆ é™¤æˆåŠŸ');
      }
    }

    // ä¿®æ”¹é€‰ä¸­
    function modifySelected() {
      Message.info('æ‰¹é‡ä¿®æ”¹åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // æŸ¥çœ‹è¯¦æƒ…
    function viewDetail(id) {
      currentDetailItem = allResults.find(item => item.id === id);
      if (!currentDetailItem) return;

      document.getElementById('detailSubject').textContent = currentDetailItem.subjectName;
      document.getElementById('detailAccount').textContent = currentDetailItem.accountName;
      document.getElementById('detailProject').textContent = currentDetailItem.projectName;
      document.getElementById('detailBook').textContent = currentDetailItem.bookName;
      document.getElementById('detailMaterialType').textContent = getTypeName(currentDetailItem.materialType);
      document.getElementById('detailMaterialSource').textContent = currentDetailItem.materialSource || '-';
      document.getElementById('detailName').textContent = currentDetailItem.name;
      document.getElementById('detailBudget').textContent = currentDetailItem.budget + 'å…ƒ/å¤©';
      document.getElementById('detailBidding').textContent = 'oCPM ' + currentDetailItem.bidding + 'å…ƒ';
      document.getElementById('detailSchedule').textContent = currentDetailItem.schedule === 'allday' ? 'å…¨å¤©' : currentDetailItem.schedule;

      document.getElementById('detailModal').classList.add('active');
    }

    // å…³é—­è¯¦æƒ…
    function closeDetail() {
      document.getElementById('detailModal').classList.remove('active');
      currentDetailItem = null;
    }

    // åˆ é™¤å•æ¡
    function deleteItem() {
      if (!currentDetailItem) return;

      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¹¿å‘Šè®¡åˆ’å—ï¼Ÿ')) {
        allResults = allResults.filter(item => item.id !== currentDetailItem.id);
        filteredResults = filteredResults.filter(item => item.id !== currentDetailItem.id);
        renderTable();
        closeDetail();
        Message.success('åˆ é™¤æˆåŠŸ');
      }
    }

    // ç¼–è¾‘å•æ¡
    function editItem() {
      Message.info('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
    }

    // ç¿»é¡µ
    function changePage(delta) {
      const totalPages = Math.ceil(filteredResults.length / pageSize);
      const newPage = currentPage + delta;

      if (newPage < 1 || newPage > totalPages) return;

      currentPage = newPage;
      renderTable();
      window.scrollTo(0, 0);
    }

    // å¯¼å‡ºExcel
    function exportExcel() {
      Message.success('æ­£åœ¨å¯¼å‡ºExcel...');
      // å®é™…é¡¹ç›®ä¸­è¿™é‡Œä¼šè°ƒç”¨å¯¼å‡ºAPI
      setTimeout(() => {
        Message.success('å¯¼å‡ºæˆåŠŸ');
      }, 1000);
    }

    // åˆ·æ–°ç»“æœ
    function refreshResults() {
      init();
    }

    // è¿”å›ä¸Šä¸€æ­¥
    function goBack() {
      window.location.href = 'rule-config.html';
    }

    // ä¿å­˜è‰ç¨¿
    function saveAsDraft() {
      const taskId = DataStore.load('currentTaskId');
      if (!taskId) {
        Message.error('æœªæ‰¾åˆ°ä»»åŠ¡ID');
        return;
      }

      // ä¿å­˜åˆ°localStorageï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
      const draftData = {
        id: taskId,
        name: 'è‰ç¨¿-' + new Date().toLocaleString(),
        results: allResults,
        status: 'draft'
      };

      DataStore.save('draft_' + taskId, draftData);
      Message.success('è‰ç¨¿å·²ä¿å­˜');
    }

    // æäº¤åˆ›å»º
    function submitCreation() {
      if (allResults.length === 0) {
        Message.error('æ²¡æœ‰å¯åˆ›å»ºçš„å¹¿å‘Šè®¡åˆ’');
        return;
      }

      if (confirm(`ç¡®å®šè¦åˆ›å»º ${allResults.length} æ¡å¹¿å‘Šè®¡åˆ’å—ï¼Ÿ`)) {
        document.getElementById('loadingOverlay').classList.add('active');

        // æ¨¡æ‹Ÿæäº¤è¿‡ç¨‹
        setTimeout(() => {
          const taskId = DataStore.load('currentTaskId') || generateTaskId();

          // ä¿å­˜ä»»åŠ¡æ•°æ®
          const taskData = {
            id: taskId,
            name: 'æ‰¹é‡åˆ›ç¼–-' + new Date().toLocaleString(),
            planCount: allResults.length,
            creator: 'å½“å‰ç”¨æˆ·',
            createTime: new Date().toLocaleString('zh-CN', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit',
              hour12: false
            }).replace(/\//g, '-'),
            status: 'pending',
            actualCount: 0,
            successCount: 0,
            failedCount: 0,
            progress: 0,
            results: allResults,
            config: {
              dimensions: DataStore.load('selectedDimensions'),
              rules: DataStore.load('generationRules')
            }
          };

          // ä¿å­˜åˆ°localStorageï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥æäº¤åˆ°æœåŠ¡å™¨ï¼‰
          DataStore.save('task_' + taskId, taskData);

          document.getElementById('loadingOverlay').classList.remove('active');
          Message.success('æäº¤æˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°åˆ—è¡¨é¡µ...');

          setTimeout(() => {
            // æ¸…é™¤ä¸´æ—¶æ•°æ®
            localStorage.removeItem('currentTaskId');
            localStorage.removeItem('selectedDimensions');
            localStorage.removeItem('generationRules');

            window.location.href = 'index.html';
          }, 1500);
        }, 2000);
      }
    }

    // ç”Ÿæˆä»»åŠ¡ID
    function generateTaskId() {
      const timestamp = Date.now().toString();
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return '100' + timestamp.slice(-3) + random;
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
